\documentclass[11pt,twocolumn]{article}
\usepackage{graphicx}
\usepackage[left=1.80cm, right=1.80cm, top=2.00cm, bottom=2.00cm]{geometry}
\usepackage{amsmath,bm}
\usepackage[colorlinks]{hyperref}
\usepackage[natbib=true, sorting=none, backend=biber, bibencoding=utf8, style=ieee]{biblatex}
\usepackage{eurosym}
\usepackage[dvipsnames]{xcolor}
\usepackage{subcaption}
\usepackage{booktabs} % for table (toprule, bottomrule)
\usepackage{enumitem} % for alphabetical enumeration 
\usepackage{accents}
\usepackage{dblfloatfix}
\usepackage[printonlyused]{acronym}
\usepackage{cleveref}



\addbibresource{main.bib}
\graphicspath{{../figures/}{../figures/example/}}


\crefname{relation}{Rel.}{Rels.}
\creflabelformat{relation}{(#2#1#3)}
\crefname{constraint}{Constr.}{Constrs.}
\creflabelformat{constraint}{(#2#1#3)}
\crefname{subequations}{Eqs.}{Eqs.}
\creflabelformat{subequations}{(#2#1#3)}

\setlength\parindent{8pt}

% style operators
\newcommand{\ie}{\textit{i.e.} }
\newcommand{\eg}{\textit{e.g.} }
\newcommand{\ubar}[1]{\underaccent{\bar}{#1}}
\newcommand{\note}[1]{\textcolor{Orange}{#1}}
\newcommand{\vpad}{\vspace{1mm}}
\newcommand{\hpad}{\hspace{15pt}}
\newcommand{\resultsin}[1]{\hspace{6pt} \bot  \hspace{6pt} #1}
\newcommand{\Forall}[1]{\hspace{10pt} \forall \,\, #1 }
\newcommand{\pdv}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\ra}{\rightarrow}


% general symbols
\newcommand{\state}[1][i]{s_{#1,t}}
\newcommand{\capacity}{S_{i}}
\newcommand{\costfactor}{\gamma^\circ_{i,t}}
\newcommand{\capacityupper}{\bar{S}}
\newcommand{\capacitylower}{\ubar{S}}
\newcommand{\muuppernom}{\bar{\mu}^\text{nom}_{i}}
\newcommand{\mulowernom}{\ubar{\mu}^\text{nom}_{i}}

\newcommand{\kk}{k~\euro~}

%generation
\newcommand{\generation}{g_{s,t}}
\newcommand{\generationpotential}{\bar{g}_{s,t}}
\newcommand{\generationshare}[1][n]{\omega_{#1,s,t}}
\newcommand{\nodalgeneration}[1][n]{g_{#1,t}}
\newcommand{\capacitygeneration}{G_{s}}
\newcommand{\capacitygenerationupper}{\bar{G}_{s}}
\newcommand{\capacitygenerationlower}{\ubar{G}_{s}}
\newcommand{\operationalpricegeneration}{o_{s}}
\newcommand{\capitalpricegeneration}{c_{s}}
\newcommand{\mulowergeneration}{\ubar{\mu}_{s,t}}
\newcommand{\muuppergeneration}{\bar{\mu}_{s,t}}
\newcommand{\muuppergenerationnom}{\bar{\mu}^\text{nom}_{s}}
\newcommand{\mulowergenerationnom}{\ubar{\mu}^\text{nom}_{s}}


% flow
\newcommand{\flow}{f_{\ell,t}}
\newcommand{\capacityflow}{F_{\ell}}
\newcommand{\capacityflowUpper}{\bar{F}_{\ell}}
\newcommand{\capacityflowLower}{\ubar{F}_{\ell}}
\newcommand{\operationalpriceflow}{o_\ell}
\newcommand{\capitalpriceflow}{c_{\ell}}
\newcommand{\mulowerflow}{\ubar{\mu}_{\ell,t}}
\newcommand{\muupperflow}{\bar{\mu}_{\ell,t}}
\newcommand{\muupperflownom}{\bar{\mu}^\text{nom}_{\ell}}
\newcommand{\mulowerflownom}{\ubar{\mu}^\text{nom}_{\ell}}

% storage
\newcommand{\storage}{g_{r,t}}
\newcommand{\storagedispatch}{\storage^\text{dis}}
\newcommand{\storagecharge}{\storage^\text{sto}}
\newcommand{\storagesoc}{\storage^\text{ene}}
\newcommand{\storageprevioussoc}{g_{r,t-1}^\text{ene}}

\newcommand{\efficiency}{\eta_{r}}
\newcommand{\efficiencydispatch}{\efficiency^\text{dis}}
\newcommand{\efficiencycharge}{\efficiency^\text{sto}}
\newcommand{\efficiencysoc}{\efficiency^\text{ene}}

\newcommand{\operationalpricestorage}{o_r}
\newcommand{\capitalpricestorage}{c_r}
\newcommand{\capacitystorage}{G_r}
\newcommand{\capacitystorageupper}{\bar{G}_r}
\newcommand{\capacitystoragelower}{\ubar{G}_r}
\newcommand{\mulowerstorage}{\ubar{\mu}_{r,t}}
\newcommand{\muupperstorage}{\bar{\mu}_{r,t}}
\newcommand{\mulowerstoragedispatch}{\ubar{\mu}_{r,t}^\text{dis}}
\newcommand{\muupperstoragedispatch}{\bar{\mu}_{r,t}^\text{dis}}
\newcommand{\mulowerstoragecharge}{\ubar{\mu}_{r,t}^\text{sto}}
\newcommand{\muupperstoragecharge}{\bar{\mu}_{r,t}^\text{sto}}
\newcommand{\mulowerstoragesoc}{\ubar{\mu}_{r,t}^\text{ene}}
\newcommand{\muupperstoragesoc}{\bar{\mu}_{r,t}^\text{ene}}
\newcommand{\muupperstoragenom}{\bar{\mu}^\text{nom}_r}
\newcommand{\mulowerstoragenom}{\ubar{\mu}^\text{nom}_r}
\newcommand{\mustateofcharge}{\lambda^\text{ene}_{r,t}}
\newcommand{\munextstateofcharge}{\lambda^\text{ene}_{r,t+1}}


% other
\newcommand{\lagrangian}{\mathcal{L}}
\newcommand{\lmp}[1][n]{\lambda_{#1,t}}
\newcommand{\lmpdiff}[1][\ell]{\lmp[#1]^\text{diff}}
\newcommand{\lmpkvl}[1][\ell]{\lmp[#1]^\text{KVL}}
\newcommand{\averagelmp}[1][n]{\bar{\lambda}_{#1}}
\newcommand{\demand}[1][n]{d_{#1,t}}
\newcommand{\nodaldemand}[1][n]{d_{#1,t}}
\newcommand{\demandshare}[1][n]{\omega_{#1,a,t}}
\newcommand{\injection}[1][n]{p_{#1,t}}
\newcommand{\netconsumption}[1][n]{p^{-}_{#1,t}}
\newcommand{\netproduction}[1][n]{p^{+}_{#1,t}}
\newcommand{\selfconsumption}[1][n]{p^{\circ}_{#1,t}}
\newcommand{\totalnetconsumption}{p^{-}_{t}}
\newcommand{\totalnetproduction}{p^{+}_{t}}
\newcommand{\totalselfconsumption}{p^{\circ}_{t}}

% network
\newcommand{\incidence}[1][n]{K_{#1,\ell}}
\newcommand{\incidencegenerator}[1][n]{K_{#1,s}}
\newcommand{\incidencestorage}[1][n]{K_{#1,r}}
\newcommand{\incidenceasset}[1][n]{K_{#1,i}}
\newcommand{\ptdf}[1][n]{H_{\ell,#1}}
\newcommand{\cycle}{C_{\ell,c}}
\newcommand{\reactance}{x_\ell}
\newcommand{\cycleprice}{\lambda_{c,t}}



% Cost Terms
\newcommand{\emission}{e_{s}}
\newcommand{\emissionprice}{\mu_{\text{CO2}}}
\newcommand{\megawatthour}{MWh$_\text{el}$}
\newcommand{\totalcost}{\mathcal{T}}

\newcommand{\cost}{\mathcal{C}}
\newcommand{\payment}[1][n]{\cost_{#1,t}}


\newcommand{\opex}{\mathcal{O}}
\newcommand{\opexgeneration}{\mathcal{O}^G}
\newcommand{\opexflow}{\mathcal{O}^F}
\newcommand{\opexstorage}{\mathcal{O}^E}
\newcommand{\capex}{\mathcal{I}}
\newcommand{\capexgeneration}{\mathcal{I}^G}
\newcommand{\capexflow}{\mathcal{I}^F} 
\newcommand{\capexstorage}{\mathcal{I}^E}
\newcommand{\emissioncost}{\mathcal{E}}
\newcommand{\scarcitycost}{\mathcal{S}}
\newcommand{\subsidycost}{\mathcal{U}}
\newcommand{\remainingcost}{\mathcal{R}}


% allocation quantities
\newcommand{\allocategeneration}[1][s, n]{A_{#1,t}}
\newcommand{\allocatestoragedispatch}[1][r, n]{A_{#1,t}}
\newcommand{\allocatepeer}[1][m \rightarrow n]{A_{#1,t}}
\newcommand{\allocateflow}[1][n]{A_{\ell,#1,t}}
\newcommand{\allocatetransaction}[1][s \rightarrow n]{A_{#1,\ell,t}}
\newcommand{\allocatestate}[1][i, n]{A_{#1,t}}

\newcommand{\allocatecost}[1][n \rightarrow i]{\cost_{#1,t}}
\newcommand{\allocateassetcost}[1][n \rightarrow i]{\cost_{#1, t}}
\newcommand{\allocategeneratorcost}[1][n \rightarrow s]{\cost_{#1, t}}
\newcommand{\allocatelinecost}[1][n \rightarrow \ell]{\cost_{#1, t}}


\newcommand{\allocatecapex}[1][n \rightarrow s,t]{\mathcal{I}_{#1}}
\newcommand{\allocatecapexgeneration}[1][n \rightarrow s,t]{\capexgeneration_{#1}}
\newcommand{\allocatecapexflow}[1][n \rightarrow \ell,t]{\capexflow_{#1}}
\newcommand{\allocatecapexstorage}[1][n \rightarrow r, t]{\capexstorage_{#1}}
\newcommand{\allocateopex}[1][n \rightarrow s]{\opex_{#1,t}}
\newcommand{\allocateemissioncost}[1][n \rightarrow s]{\emissioncost_{#1,t}}
\newcommand{\allocatescarcitycost}[1][n \rightarrow i]{\scarcitycost_{#1,t}}
\newcommand{\allocatesubsidycost}[1][n \rightarrow i]{\subsidycost_{#1,t}}



\begin{document}


\title{Tracing prices: A flow-based cost allocation for optimized power systems}
\author{Fabian Hofmann\\Frankfurt Institute for Advanced Studies (FIAS), 60438 Frankfurt, Germany\\
Email: hofmann@fias.uni-frankfurt.de}

\date{}

\twocolumn[
  \begin{@twocolumnfalse}

    \maketitle
    
    \begin{abstract}
        Power system models are a valuable and widely used tool to determine cost-minimal future operation and investment under political or ecological boundary conditions. Yet they are silent about the allocation of costs of single assets, as generators or transmission lines, to consumers in the network. Existing cost-allocation methods hardly suit large networks and do not take all relevant costs into account. This paper bridges this gap. Based on flow tracing, it introduces a peer-to-peer or more precisely an asset-to-consumer allocation of all costs in an optimized power system. The resulting cost allocation is both locally constrained and aligned with locational marginal prices in the optimum. The approach is applied and discussed using a future German scenario.
        \vtop{%
         \vskip0pt
          \hbox{%
          \includegraphics[width=\linewidth]{graphical_abstract.png}
          }%
        }
        
    \end{abstract}
 
\end{@twocolumnfalse}
]


\subsection*{Highlights}
\begin{itemize}
    \item In long-term equilibria a network asset recovers its variable and investment cost from its operation based revenue
    \item Flow tracing is used as a basis to allocate the operation of assets to consumers. 
    \item Allocated flows have to be reshaped such that the Kirchhoff Current Law and the Kirchhoff Voltage Law are respected. 
    \item Using operational and shadow prices from constraints, all costs are assigned in an P2P manner.
    \item The cost assignments are locally constraint and in alignment with the nodal pricing scheme of the optimum.    
    % \item Upper and lower capacity expansion limits modify the revenue per asset, which however correctly reflects in the cost allocation
    \item In a low-carbon scenario for Germany, regions with high renewable potentials profit from investments compensated by remote buses.   
\end{itemize}


\subsubsection*{Nomenclature}

\begin{table}[h]
    \centering
    \begin{tabular}{ll}
        $\lmp$ & Locational Market Price at bus $n$ and  \\ & time step $t$ in \euro/MW \vpad \\
        $\demand$ & Electric demand per bus $n$ \\ & time step $t$ in MW  \vpad \\
        $\state$ & Operational state of asset $i$, \\ & at time step $t$  in MW \vpad \\
        % $\generation$ & Electric generation of generator $s$, \\ & time step $t$  in MW \vpad \\
        % $\flow$ & Active power flow on line $\ell$, \\ & time step $t$ in MW   \vpad \\
        $o_i$ & Operational price of asset $i$ in \euro/MWh \vpad \\
        $c_i$ & Capital Price of asset $i$ in \euro/MW \vpad \\
        % $\capacitygeneration$ & Generation capacity in MW \vpad \\
        % $\capacityflow$ & Transmission capacity in MW \vpad \\
        $\incidenceasset$ & Incidence values ($\ne$0  if $i$ is attached to $n$)  \vpad 
    \end{tabular}
\end{table}

\subsection*{Acronyms}
\begin{acronym}[UMLX]
    \acro{AC}{alternating current}
    \acro{AP}{Average Participation}
    \acro{CAPEX}{capital expenditures}
    \acro{CO2}[$\mathrm{CO_2}$]{carbon dioxide}
    \acro{DC}{direct current}
    \acro{FA}{Flow Allocation}
    \acro{HVAC}{high-voltage alternating current}
    \acro{HVDC}{high-voltage direct current}
    \acro{Hydro}{hydro-electric dams}
    \acro{Hydrogen}[H$_2$-storage]{hydrogen storage}
    \acro{KCL}{Kirchhoff's current law}
    \acro{KKT}{Karush–Kuhn–Tucker}
    \acro{KVL}{Kirchhoff's voltage law}
    \acro{LCOE}{levelized cost of electricity}
    \acro{LMP}{locational marginal price}
    \acro{LOPF}{linear optimal power flow}
    \acro{OCGT}{open-cycle gas turbine}
    \acro{OPEX}{operational expenditures}
    \acro{P2P}{peer-to-peer}
    \acro{PHS}{pumped-hydro-storage}
    \acro{PTDF}{power transfer distribution factors}
    \acro{PV}{photovoltaic}
    \acro{PyPSA-EUR}{PyPSA-Europe}
    \acro{PyPSA-Eur}{\acs*{PyPSA} Europe}
    \acro{PyPSA}{Python for Power System Analysis}
    \acro{ROR}{run-of-river}
    \acro{SOAF}[SO\&AF]{\acs*{ENTSO-E} Scenario Outlook and Adequacy Forecast}
    \acro{TSO}{transmission system operator}
    \acrodefplural{TSO}{transmission system operators}
\end{acronym}


\section{Introduction}

Today's power systems are subject to a deep and ongoing transformation. The shift from controllable to variable, weather-driven power generation as well as the constant improvement and innovation of technology require rigorous system planning and international cooperation \cite{pfenninger_energy_2014,schlachtberger_benefits_2017}. The core of the challenge manifests in the total costs of the system. Firstly, these should be as low as possible while meeting ecological and techno-economic standards. Secondly, they must be distributed in a fair and transparent manner among all agents in the power system. It is central to identify the drivers of costs and address them appropriately.  
In this respect, power system models are a valuable and widely used tool \cite{pfenninger_energy_2014,bazmi_sustainable_2011,pereira_generation_2017,brown_sectoral_2019}. Many studies for countries and regions throughout the world exist that lay out how renewable energy penetration can be expanded at minimum costs. Yet they largely remain silent how and on which grounds these costs are allocated among consumers. 

This paper fills this gap. In an optimized network, the characteristics of each time step are in detailed considered to allocate all system costs. We build on two fundamental concepts: first, the zero profit condition that states that, in the optimum, the revenue of each network asset, i.e., generator, transmission line etc., matches its operational and capital expenditures. Second, the flow tracing method, following Bialek’s Average Participation (AP) approach \cite{bialek_tracing_1996}, that allocates the use of network assets to consumers in a locally constrained fashion. 
Combining these two concepts allows for an transparent allocation of all operational (OPEX) and capital expenditures (CAPEX) to the consumers in the network. 
 
The literature discussed and applied the concept of flow-based cost allocation in a range of papers \cite{galiana_transmission_2003,shahidehpour_market_2002,meng_investigation_2007,schafer_allocation_2017,nikoukar_transmission_2012,arabali_pricing_2012,wu_locational_2005}. Shahidehpour et al. provide a profound insight into allocating congestion cost and transmission investments to market participants using different allocation techniques \cite{shahidehpour_market_2002}. Specifically, they set out that Generation Shift Factors, i.e. the marginal contribution of generators to a flow on line, allow to represent locational marginal prices (LMP) as a superposition of the LMP at the reference bus, the price for congestion, and a price for losses. The approach in \cite{meng_investigation_2007} expands this relation for contributions based on the AP scheme, which allows for an accurate estimation of the LMP, however it does not reflect the exact LMP of an optimized network. A similar approach is used in \cite{schafer_allocation_2017} that allocates electricity prices of a non-optimal power dispatch using flow tracing.


In this paper, we bring together the advantages of the studies discussed above. Our approach assures localized cost allocations while fully aligning payments to the nodal pricing scheme based on the LMP. It serves to facilitate transparency and cost-benefit analysis in network plannings such as the Ten Year Network Development Plan \cite{entso-e_completing_2020} or the German Netzentwicklungsplan (NEP) \cite{bundesnetzagentur_netzentwicklungsplan_2020}. Further, it provides a point of departure for usage-based transmission cost allocation.

The first section formulates the operation based revenue for different kind of assets (\cref{sec:zero_profit_rule}),  the AP allocation scheme and derived allocations from asset to consumer (\cref{sec:dispatch_allocations}), the cost allocation and the impact of additional constraints (\cref{sec:general_scheme,sec:design_constraints}), a numerical example (\cref{sec:numerical_example}). \Cref{sec:application_case} applies the cost allocation to a optimized German power system with a high share of renewable power generation and evaluates the allocated costs.  


\section{Price Tracing}

Assume an electricity network with N nodes, L lines and T time steps. Using the linearized power flow approximation, the power flow $\flow$ on a passive line $\ell$ at time $t$ relates to the nodal generation $\nodalgeneration$ and demand $\demand$ at node $n$ according to 
\begin{align}
    \flow = \sum_n \ptdf \left(\nodalgeneration - \demand \right) \Forall{t}
\end{align}
where $\ptdf$ are the \ac{PTDF} that embody the linearized Kirchhoff circuit laws. 
% \ac{KCL} and \ac{KVL}.
% \footnote{for transport models or networks with \acl{HVDC} lines, these can be artificially derived from the network flow using the formulation in \cite{hofmann_flow_2020}}

In a nodal pricing scheme, the cost of the electrical demand $\demand$ at bus $n$ and time $t$ is proportional to the corresponding \ac{LMP} $\lmp$, 
\begin{align}
    \text{Demand Cost}: \lmp\, \demand
    \label{eq:demand_cost}
\end{align}
Similarly, the revenue of the dispatch $\nodalgeneration[m]$ at bus $m$ is given by 
\begin{align}
    \text{Dispatch Revenue}: \lmp[m] \, \nodalgeneration[m] 
    \label{eq:dispatch_revenue}
\end{align}
The congestion revenue of line $\ell$ at time $t$ is 
\begin{align}
    \text{Congestion Revenue}: \lmp[\ell]\, \flow .
    \label{eq:congestion_revenue}
\end{align}
where in the absence of network cycles the revenue per transported MWh $\lmp[\ell]$ is the price difference $\lmpdiff$ between ending and starting node of line $\ell$. In case of network cycles, the price of the \ac{KVL} $\lmpkvl$ can optionally be added to $\lmp[\ell]$ in order to align congestion revenues to expenditures in a long-term equilibrium (see APPENDIX for details) which leads to $\lmp[\ell] = \lmpdiff + \lmpkvl$.   
% Using the Incidence Matrix $\incidence$, which is 1 if $n$ is a starting node of line $\ell$, -1 if $n$ is a ending node of line $\ell$ and zero otherwise, the price differences are given by $\lmpdiff = - \sum_n \incidence \lmp$.

Naturally, the sum of all demand costs at time $t$ equal the sum of all revenues at time $t$, that is 
\begin{align}
    \sum_{n} \lmp\, \demand  = \sum_{m} \lmp[m]\, \nodalgeneration[m] + \sum_{\ell} \lmp[\ell]\, \flow \Forall{t} .
    \label{eq:total-demand-cost}
\end{align}
Whereas this equality relates the sum of costs, the relations between single demands and single revenues remain undefined. The following shows that by tracing flows through the network, it is possible fill this gap and derive a consistent cost allocation between consumers, generators and transmission lines. 

In a electricity system, dispatch and flow can be considered as a superposition of individual contributions of single nodes and assets. In order to artificially quantify these contribution, the literature provides various methods, named \ac{FA} methods. Each of these follow a specific set of assumptions which lead to \ac{P2P} allocations $A_{m \rightarrow n}$ which measure the power produced at node $m$ and consumed at node $n$. \ac{AP}, also known as Flow Tracing \cite{bialek_tracing_1996}, is a flow allocation scheme that traces the power injection at bus $m$ through the network up to its sink $n$ while applying the principle of proportional sharing. The method is illlustrated in .... and mathematically documented in \cref{sec:net_ap}. According to the principle, the proportion of flows, which originate from different sources while meeting the same bus, determines the mix of all outgoing flows from this bus (including nodal withdrawal). The advantage of the \ac{AP} method is the spatial confinement of \ac{P2P} allocations $A_{m \rightarrow n}$ \cite{hofmann_techno-economic_2020}. Naturally, the sum of all recipients yields the nodal generation at $m$, thus
\begin{align}
    \nodalgeneration[m] = \sum_n \allocatepeer \Forall{m.t} 
    \label{eq:nodalgeneration-breakdown}
\end{align}   
Note that due to reasons to follow, we only resort to \ac{P2P} allocations of the \ac{AP} method. Hence, independent from the \ac{AP} method, let $\allocateflow$ denote the flow contribution of demand $\demand$ such that all the contributions sum up the flow on line $\ell$,  
\begin{align}
    \flow = \sum_n \allocateflow \Forall{\ell,t}.
    \label{eq:flow-breakdown}
\end{align}
We insert \cref{eq:nodalgeneration-breakdown,eq:flow-breakdown} into \cref{eq:total-demand-cost} and impose that the equality holds separately for all summands referring to $n$ which leads us to 
\begin{align}
    \lmp\, \demand &= \sum_m \lmp[m] \allocatepeer + \sum_\ell \lmp[\ell] \allocateflow \Forall{n,t}
    \label{eq:demand-cost-allocation}
\end{align}
This equation assigns the nodal demand cost on left to contributions of dispatch and congestion revenues on the right. Thus it states what consumers at $n$ have to pay to generators at $m$ and the transmission line $\ell$. The equation introduces N new equalities for each time step of which the necessary degree of freedom comes from the yet undefined flow contribution $\allocateflow$. In APPENDIX we proof that 
\begin{align}
    \allocateflow = \sum_m \ptdf[m] (\allocatepeer - \delta_{nm} \demand) 
    \label{eq:allocateflow}
\end{align}
solves \cref{eq:demand-cost-allocation} where $\delta_{mn}$ is 1 for $m=n$ and zero otherwise. We see that the flow contribution $\allocateflow$ directly follows from the \ac{P2P} allocation $\allocatepeer$. Thus, the contributions of dispatch and congestion revenue to the demand cost in \cref{eq:demand-cost-allocation} can be expressed as a function of the \ac{LMP} $\lmp$ and the \ac{P2P} allocation $\allocatepeer$ only. Note that this holds true because the allocations on lines given in \cref{eq:allocateflow} obey the (linearized) \ac{KVL}\footnote{for transport models or networks with \acl{HVDC} lines, the PTDF can be artificially derived from the network flow using the formulation in \cite{hofmann_flow_2020}}. The flow contributions determined by the \ac{AP} method do not respect the \ac{KVL} as already stated by \cite{galiana_transmission_2003}, thus applying them to \cref{eq:demand-cost-allocation} would lead to an inequality. This inequality also explains the inexact cost estimation in \cite{meng_investigation_2007} which are purely based on the flow contributions of the \ac{AP} method. \\

Following the formulation in \cite{schafer_tracing_2020}, \ac{P2P} allocation $\allocatepeer$ breaks down into contributions $\allocategeneration$ from generator $s$ to demand at $n$ which are set in proportion to the contribution of generator $s$ to $\nodalgeneration[m]$. The new allocation then fulfills
\begin{align}
    \generation = \sum_n \allocategeneration
    \label{eq:generation-breakdown}
\end{align}  
with $\generation$ being the output of generator $s$ at time $t$. \\


The \textit{Price Tracing} method for a network with a linearized power flow and a nodal pricing scheme builds on the above equations and defines  
\begin{subequations}
    \begin{align}
    \allocategeneratorcost = \lmp[s] \allocategeneration
\end{align}
as the payment from consumers at $n$ to generator $s$ as well as  
\begin{align}
    \allocatelinecost = \lmp[\ell] \allocateflow
\end{align}
\end{subequations}
as the payment to line $\ell$. For consistency, let $\payment = \lmp \demand$ denote the nodal payment which according to \cref{eq:demand-cost-allocation} is $\payment = \sum_s \allocategeneratorcost + \sum_\ell \allocatelinecost$. 

Note that storage units such as batteries may be easily introduced into the Price Tracing method: When they discharge power, they are treated like generators and when they charge power, they are treated like consumers. For the latter, the allocations $\allocategeneration$ and $\allocateflow$ have to be subdivided into consumers and charging storages at $n$.    

Price Tracing enables to track the money flow in a network with optimal or sub-optimal prices. The general concept also suits for non-linear \ac{AC} networks. 
Yet in this case, the allocations $\allocategeneration$ and $\allocateflow$ should be calculated using the Z-Bus flow allocation presented in \cite{conejo_z-bus_2007} which naturally respects both Kirchhoff Circuit Laws. This approach is discussed in APPENDIX.



\subsection{Numerical Example}
In the following we illustrate the Price Tracing method in a numerical example and start with a three node network with two lines. We optimize the dispatch for one time step and perform the cost allocation. We then add a third line to the system and repeat the cost allocation in order to depict the effect of the network cycle.   


\subsubsection*{Network without Cycles}
\Cref{fig:example-network} shows the optimized three-node network with relevant numbers. Both, bus 1 and 3 have a fixed demand of 30 MW and 50 MW respectively. Bus 1 has a generator with a marginal price at 6 \euro/MWh. Bus 3 has a cheaper generator with marginal price at 4 \euro/MWh. The maximal capacity of both generators is 50 MW. The transmission line from 1 to 3 has a capacity of 60 MW and line from 3 to 1 a capacity of 30 MW. Since the latter limits the dispatch of the cheaper generator, there is a price difference between bus 1 and 3 of 2 \euro/MWh. Due to the absence of network cycles this price difference defines the congestion revenue of line 3--1. Line 1--2 is not bound, hence there is no congestion revenue and bus 2 and 1 have the same price of 6 \euro/MWh.  
\begin{figure}[h]
    \includegraphics[width=\linewidth]{simple-example-wo-cycles/network.png}
    \caption{Example network with nodal pricing scheme. Dispatch revenue as well as demand cost per MWh are given by the \ac{LMP} $\lambda$. Congestion revenue per MWh is given by the price difference $\lambda^\text{diff}$ of the connecting nodes.}
    \label{fig:example-network-wo}
\end{figure}

According to the \ac{AP} method, the demand at bus~1 is supplied by the local generator. In contrast, bus~2 imports power from bus~1 and bus~3. Applying the Price Tracing method we calculate the cost allocations $\mathcal{C}_{n\rightarrow s}$ and $\mathcal{C}_{n\rightarrow \ell}$ which we show in \cref{fig:example-network-payoff-wo}. Consumers at bus 1 only have to compensate the local generator with 180 \euro. Consumers at bus~2 pay for the congestion revenue of line 1--3, the the total power production at bus~3 and the remaining dispatch revenue of the generator at bus~1.    

\begin{figure}[h]
    \includegraphics[width=\linewidth]{simple-example-wo-cycles/example_payoff.png}
    \caption{Allocation matrices $\mathcal{C}_{n\rightarrow s}$ (left) and $\mathcal{C}_{n\rightarrow \ell}$ (right) for the dispatch and congestion revenue for the network in \cref{fig:example-network-wo}.}
    \label{fig:example-network-payoff-wo}
\end{figure}

The consistency of the cost allocation can be easily double-checked. The sum of a column  yields the payment to a generator/line. These exactly match the values given by the dispatch and congestion revenue defined in \cref{eq:dispatch_revenue,eq:congestion_revenue}. In turn the sum of a row gives the total amount that consumers at a bus have to pay. These exactly match the demand cost $\lambda_n \, d_n$. For example the sum of payments of consumers at bus~3 is 300~\euro\, which is the price of 6~\euro/MWh times the consumption of 50~MWh. \\



\subsubsection*{Network with Cycle}

We now add a line from bus~3 to bus~2 with a capacity of 30~MW. This introduces a \ac{KVL} constraints for the three lines, requiring that the sum of flows following the cycle is zero\footnote{For simplicity we assume a uniform impedance in the example.}. As shown in \cref{fig:example-network} the new line capacity is bounded at 30~MW. The new cost optimum results in a higher price at bus~2 of 8\euro/MWh despite that the cheaper generator~2 produces 10~MW more than before. This result becomes clear when considering that the new line restricts the flow on lines 1--3 and line 1--2, due its low capacity of 30~MW in combination with the \ac{KVL}.   

\begin{figure}[h!]
    % \begin{subfigure}[c]{0.5\linewidth}
        \includegraphics[width=\linewidth]{simple-example/network.png}
        \caption{Example network with nodal pricing scheme and a network cycle. Now, due to the \ac{KVL} a new constraint adds to the optimzation problem. Optionally, the congestion revenue per MWh may include shadow prices of the \ac{KVL} constraint $\lmpkvl$, thus $\lmp[\ell] = \lmpdiff + \lmpkvl$.}
        \label{fig:example-network}            
    % \end{subfigure}
\end{figure}

\begin{figure}[h!]
    \begin{subfigure}[c]{\linewidth}
        \includegraphics[width=\linewidth]{simple-example/example_payoff.png}
        \subcaption{Without \ac{KVL} shadow prices}
        \label{fig:example-network-payoff}
    \end{subfigure}
    \begin{subfigure}[c]{\linewidth}
        \includegraphics[width=\linewidth]{simple-example/example_payoff-kvl.png}
        \subcaption{With \ac{KVL} shadow prices}
        \label{fig:example-network-payoff-kvl}
    \end{subfigure}
    \caption{Cost allocations $\allocategeneratorcost$ and $\allocatelinecost$ for the dispatch and congestion revenue for the network in \cref{fig:example-network}.}
    \label{fig:example-network-payoff-all}
\end{figure}

The prices $\lambda_\ell^\text{KVL}$ of line $\ell$ are returned as the shadow price of the \ac{KVL} constraint in the cost-optimization, see APPENDIX for details. The Price Tracing method optionally allows to consider these in the congestion revenue without loosing its consistency with the demand costs. 



\Cref{fig:example-network-payoff} shows the cost allocation without considering the \ac{KVL} shadow prices. We see that the congestion revenue of the new line 2--3 is the highest with 120~\euro/MWh. In contrast \cref{fig:example-network-payoff-kvl} shows the cost allocation under consideration of the \ac{KVL} shadow prices. Here, the congestion revenues are shifted towards 1--2 and 1--3. Note that this shift accounts for the fact that it is line 2--3 that limits the flow on line 1--2 and 1--3.    

Again both cost allocation schemes are consistent with the total demand cost, dispatch and congestion revenues. For the following we consider the \ac{KVL} shadow prices in the cost allocation due to the alignment with the long-term equilibrium.  



\section{Application Cases}
\label{sec:application_case}
\begin{figure*}[h!]
    \centering
    \includegraphics[width=\linewidth]{de50bf/network}
    \caption{Brownfield optimization of the German power system. The left side shows existent renewable capacities, matching the total capacity for the year 2017, which serve as lower capacity limits for the optimization. The right side shows the capacity expansion of renewable resources as well as installation of backup gas power plants. The effective CO$_2$ price is set to 120 \euro\, per tonne CO$_2$ emission.}
    \label{fig:network}
\end{figure*}

% 
% 
We now showcase the behavior of the cost allocation in a more complex system and apply it to an cost-optimized German power system model with 50 nodes and one year time span with
 hourly resolution. The model builds up on the PyPSA-EUR workflow \cite{horsch_jonas_pypsa-eur_2020} with technical details and assumptions reported in \cite{horsch_pypsa-eur_2018}. 

We follow a brownfield approach where transmission lines can be expanded starting from today's capacity values, originally retrieved from the ENTSO-E Transmission System Map \cite{entso-e_entso-e_nodate}. Pre-installed wind and solar generation capacity totals of the year 2017 were distributed in proportion to the average power potential at each site excluding those with an average capacity factor of 10\%. Further, wind and solar capacity expansion are limited by land use restriction. These consider agriculture, urban, forested and protected areas based on the CORINE and NATURA2000 database \cite{eea_corine_2012,eea_natura_2016}. Pumped Hydro Storages (PHS) and Run-of-River power plants are fixed to today's capacities with no more expansion allowed. Additionally, unlimited expansion of batteries and H$_{2}$-storages and Open-Cycle Gas Turbines (OCGT) are allowed at each node. 
% 
% 
\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{de50bf/average_price}
    \caption{Load-weighted average electricity price $\averagelmp$ per region in the optimized German power system. Regions in the middle and south of Germany have high prices whereas electricity in the North with a strong wind, transmission and OCGT infrastructure is cheaper.}
    \label{fig:average_price}
\end{figure}
We impose an carbon price of 120 \euro\, per tonne-CO$_{2}$ which, for OCGT, adds an effective price of 55 \euro/\megawatthour (assuming a gross emission of 180~kg/MWh and an efficiency of 39\%). All cost assumptions on operational costs $o_i$ and annualized capital cost $c_i$ are summarized in \cref{tab:cost_assumptions}. 

The optimized network is shown in  \cref{fig:network}. On the left we find the lower capacity bounds for renewable generators and transmission infrastructure, on the right the optimized capacity expansion for generation, storage and transmission. Solar capacities are expanded in the south, onshore and offshore wind in the upper north and most west. Open-Cycle Gas Turbines (OCGT) are build within the broad middle of the network. Transmission lines are amplified in along the north-south axis, including one large DC link, associated with the German S\"ud-Link, leading from the coastal region to the southwest. 
The total annualized cost of the power system roughly sums up to 42 billion \euro.
% 

\Cref{fig:average_price} displays the load-weighted average electricity price $\averagelmp$ per region, defined by 
\begin{align}
    \averagelmp = \dfrac{\sum_{t} \lmp \demand}{\sum_t \demand} = \dfrac{\sum_{t} \payment }{\sum_t \demand}    
\end{align}
We observe a relatively strong gradient from south (at roughly 92 \euro/MWh) to north (80 \euro/MWh). Regions with little pre-installed capacity and capacity expansion, especially with respect to renewable generation, tend to have higher prices. The node with the lowest LMP in the upper northwest, stands out through high pre-installed offshore capacities. \\
 
\subsection{Transparent Network Tariff}

Among other countries, electricity consumers in Germany pay a uniform network tariff, the ``Netzentgelte''. These are based on an opaque calculation and assessment of all network cost for each Transmission System Operator in addition to a individually derived profit margin. 

The Price Tracing method allocates all congestion revenues to consumers in the network, given by $\allocatelinecost$. This cost allocation can be used to define a new network tariff $\averagelmp^\text{grid}$ for each bus-region $n$ in the network:     
\begin{align}
    \averagelmp^\text{grid} = \dfrac{\sum_{t,\ell} \allocatelinecost}{\sum_t \demand}.
\end{align}
This is the average price that consumers at $n$ pay for the transmission of electricity. These include compensations for all capital investments taken by the network operators. Note since the cost-optimum represents a long-term equilibrium, the total revenue per network asset equals the total \ac{OPEX} and \ac{CAPEX}. Therefore, the network tariffs $\averagelmp^\text{grid}$ do not result in any profits. 

A further advantage of this network tariff allocation lays in the possibility to differentiate between different network operators. The quantity 
\begin{align}
    \averagelmp[n\rightarrow \ell]^\text{grid} = \dfrac{\sum_{t} \allocatelinecost}{\sum_t \demand}
\end{align}
decomposes the network tariff to single lines, naturally fulfilling  $\averagelmp^\text{grid} = \sum_\ell \averagelmp[n\rightarrow \ell]^\text{grid}$. This facilitates to trace back which congested lines are the strongest drivers to the local network tariff.   

Figure ... shows the network tariffs for all regions of the showcase model. 


\subsection{Consistent CO$_2$-Cost Allocation}


$\allocategeneratorcost$ allocates all dispatch revenues from generators to consumers. Naturally, the revenues of conventional generators include costs accounting for CO$_2$ emissions. These can be separately allocated to the consumers by weighting the dispatch allocation $\allocategeneration$ with the effective CO$_2$ price $\emissionprice$ per produced MWh at generator $s$. Introducing the emission cost allocation   
\begin{align}
    \allocateemissioncost = \emissionprice \allocategeneration
\end{align}       
into a power market, incentivizes consumers to reduce their emission intensize power consumption and leads to a transparent polluter pay principle. The average emission cost per consumed MWh is given by 
\begin{align}
    \averagelmp^{\text{CO}_2} = \dfrac{\sum_{t,\ell} \allocateemissioncost}{\sum_t \demand}.
\end{align} 
\Cref{fig:opex_price} depicts the price for the showcase model. One easily sees that it is very much aligned with the deployment of OCGT generators whose revenue from emissions is indicated by the size of the circles.   
Note, that this can also be applied to networks without a nodal pricing scheme.  

\begin{figure}[h!]
    \includegraphics[width=\linewidth]{de50bf/maps_price_ptpf_net/co2_cost_total.png}
    \caption{Average CO$_2$ cost per consumed MWh. The effective prices are indicated by the color of the region, the circles are drawn in proportion to the revenue per regional generators.}
    \label{fig:opex_price}
\end{figure}


\subsection{Transparent Nodal Pricing Scheme}

\Cref{fig:direct-allocation} compares the P2P cost assignments of the region with the lowest average LMP (left side) against the one with the highest LMP (right side). The low-price region in the north-west is fairly independent of investments in the transmission system. It profits from local offshore wind farms which are partly payed by subsidies, see \cref{fig:subsidy}. Only a small share of the payments is allocated to remote OCGTs. In contrast, the high-priced region is highly dependent on local OCGT and the transmission system, which causes high allocated OPEX, emission cost and transmission CAPEX. Its payments to  onshore and offshore wind infrastructure are low despite a third of its supply comes from wind power. Hence, the wind power supply at this region is not restricted by exhausted wind power resources but by bottlenecks in the transmission system.  

Finally, \cref{fig:locality} draws the cumulative share of P2P cost assignments of a function of the distance between producer and consumer. The data is shown for all technologies separately. The later the curve reaches 100\% the deeper the price of a technologies penetrates into the network. Offshore wind has the strongest price influence to remote buses. Only 10-30\% of its expenses are compensated by local consumers and the rest is assigned to remote buses, especially those with high demand (compare \cref{fig:average_demand}). The contrast between Hydrogen Storage and Battery sticks out. Whereas Battery costs are hardly assigned to other buses, almost 50\% of the Hydrogen Storage costs are payed by remote buses. It underlines the fundamental functionality of the two technologies. Hydrogen storage are located at buses with high wind generation and balance out their long-term excess and deficit energy. The dispatched power follows a similar way through the network as the wind power. The battery on the other hand pairs with local solar production and its locally constraint dispatch and flow.     


\begin{figure*}[h!]
    \centering
    \begin{subfigure}[c]{.6\linewidth}
    \includegraphics[width=\linewidth]{de50bf/ptpf_net_to_lowest-lmp}
    \end{subfigure}
    \hspace{-.2151\linewidth}
    \begin{subfigure}[c]{.6\linewidth}
    \includegraphics[width=\linewidth]{de50bf/ptpf_net_to_highest-lmp}
    \end{subfigure}
    \caption{Comparison of payments of the region with the \textbf{lowest LMP (left)} and the region with the \textbf{highest LMP (right)}. The region is colored in dark blue. The circles indicate to which bus and technology OPEX and CAPEX are assigned. The thickness of the lines is proportional to dedicated payments.}
    \label{fig:direct-allocation}
\end{figure*}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{de50bf/locality_all_ptpf_net}
    \caption{Average distance between payer and receiver for different technologies and shares of the total production.}
    \label{fig:locality}
\end{figure}


\subsection{Fair Consideration of Direct Peer-to-Peer Tradings}

The \ac{P2P} allocations $\allocatepeer$ is a result of the \ac{AP} algorithm. However as long as the allocation fulfills \cref{eq:flow-breakdown,eq:generation-breakdown} it may be modified. Hence there is the degree of freedom to pre-allocate direct \ac{P2P} tradings $\allocatepeer^\text{Trade}$ and to allocate the remaining generation and demand with the \ac{AP} method, thus 
\begin{align}
    \allocatepeer = \allocatepeer^\text{Trade} + \allocatepeer^\text{AP} .
\end{align}
This leads to a Price Tracing which includes exchanges between \ac{P2P} traders as well as ordinary market participants. Note that as soon a the trades between the 



\subsection{Revenue Decomposition}

In a long-term equilibrium without any exogenous constraints, the total revenue of a network asset are exactly met by its total \ac{OPEX} and \ac{CAPEX}. This relation is known as the zero-profit rule and is an outcome of the \ac{KKT} conditions of the underlying cost-minimization problem derived in detail in APPENDIX. However, if the cost-optimum is constrained exogenously, for example by a maximum \ac{CO2} emission, the zero-profit rule is shifted and more cost contributions have to be considered \cite{brown_decreasing_2020}. 

\begin{table}[h!]
    \caption{Exemplary contributions to the revenue of network assets highlighted in this work. Depending on the formulation of the optimization problem, the list changes and may possibly include other terms.}
    \begin{center}
        \begin{tabular}{c|c p{0.3\textwidth}}
            \toprule
            \text{Contribution} & Symbol \\
            \midrule
            \text{OPEX} & $\opex$ \\
            % \midrule
            \text{CAPEX} & $\capex$ \\
            % \midrule
            \text{Emission Tax} & $\emissioncost$ \\
            % \midrule 
            \text{Scarcity Rent} & $\scarcitycost$ \\
            \text{Subsidies} & $\subsidycost$ \\
            \vdots & \vdots \\
            \bottomrule
        \end{tabular}                
    \end{center}
    \label{tab:contributions}
\end{table}

\noindent
\Cref{tab:contributions} summarizes possible revenue contributions for a typical investment problem. On top of \ac{OPEX} and \ac{CAPEX}, the gross power production of fossil generators is charged with an emission tax $\emissioncost$ per produced MWh. Further, the capacity expansion for (a subset of) generators, lines and storage units are constrained to an upper limit, embodying for example land-use restrictions. If bounded, the limits lead to a Scarcity Rent $\scarcitycost$ which translates to a compensation for higher competed investments, but can also be ignored in case an asset is fixed to its existent, amortized capacity. Likewise, assets may be constrained to lower capacity requirements which reflect \ie  existing infrastructure known as  Brownfield constraints. If bounded, the lower limit reduces the revenue of the corresponding asset and leaves a Subsidy Cost $\subsidycost$ which have to compensated by external institutions (government, community) or are simply ignored in case the asset is already amortized. This row of cost terms changes or extends as soon as the corresponding constraints are removed or others are added. Their exact definition and connection to the \ac{KKT} variables of the investment problem, the shadow-prices, is given in APPENDIX. 

Note that all contributions except for the Subsidies can be expressed in terms of the operation of an asset, namely generation $\generation$ and $\flow$. This allows to propagate the decomposition of the revenue to the Price Tracing quantities, thus 
\begin{align}
    \allocategeneratorcost = \allocateopex + \allocatecapex + \allocateemissioncost + \allocatescarcitycost - \subsidycost_s
\end{align} 
and 
\begin{align}
    \allocatelinecost = \capex_{n \ra \ell, t} + \scarcitycost_{n \ra \ell, t} - \subsidycost_\ell
\end{align}
Note that transmission lines are assumed to have neither \ac{OPEX} nor emission tax.




\section{Limitations}
The presented cost allocation is based on the linear power flow approximation. Yet, the method is equally applicable to a system with an Optimal Power Flow (OPF), \ie full AC power flows. Yet for this case, the AP scheme is not the correct choice as the misalignment from the Kirchhoff Voltage Law cannot not be corrected subsequently. Rather, the Z-Bus flow allocation presented in \cite{conejo_z-bus_2007} might suit better as it naturally respects both circuit laws. Allocating on the basis of the full power flow introduces an additional cost term $\remainingcost^\text{Loss}$ accounting for the transmission loss which is compensated by the consumers and mirrors in the LMP. 

The used optimization does not take security constrains of the transmission system into account. These may be incorporated following the approach in \cite{nikoukar_transmission_2012}. 

We restricted the application to long-term investment models with perfect foresight. However, the cost allocation can as well be applied to short-term planning models with fixed capacities. The revenue from the capacity limits then builds the basis for amortization and future investments.

The optimization assumes a fix demand time series. As shown in \cref{fig:capex_duration_curve} this leads to high if not unrealistic LMP. Introducing a value of loss load as proposed in \cite{schroder_value_2015}  would screen away these and lead to more evenly distributed allocations. 


\section{Conclusion}

A new cost-allocation scheme based on peer-to-peer dispatch allocations from assets to consumers was presented. Within a long-term equilibrium OPEX and CAPEX of each asset are payed back by the operation based revenue. Using flow allocation, we are able to allocate the operation and therefore the assigned costs of assets to consumers in the network. For three typical classes of assets, namely generators, transmission lines and storage units, we showed how operational prices and shadow prices must be weighted with the dispatch allocation in order to allocate all system costs. Further we highlighted the impact of minimum capacity requirements and maximum installation potentials. These alter the revenues per asset and therefore the cost allocations. For lower capacity requirements, assets may not recover all the expenses from the revenue. In this case the cost difference has to be subsidized or simply be ignored, in case the asset is already amortized. Contrary, upper capacity expansion limits lead to an additional charge for consumers which have to compensate for an additional scarcity rent of the assets.  
Applied to a optimized German power system with an imposed price of 120 \euro\, per tonne CO$_2$ equivalent. The cost allocation shows low electricity prices for consumers in a renewable German system are achieved on a transparent basis. The cost allocation shows how buses remote from wind farms pay higher prices due to increased reliance in transmission and backup capacity. On the other hand, buses with high renewable installation spend most payments to local assets. 


\subsubsection*{Reproducibility and Expansion}

All figures and data points can be reproduced by using the \textit{python} workflow in \cite{hofmann_pypsa-costallocation_2020}. The automated workflow allows for higher spatial resolution of the network (scalable up to a the full ENTSO-E Transmission System Map) and optionally taking the total European power system into account.  

\subsection*{Funding}
This research was funded by the by the German Federal Ministry for Economics Affairs and Energy (BMWi) in
the frame of the NetAllok project (grant number 03ET4046A) \cite{bundesministerium_fur_wirtschaft_und_energie_verbundvorhaben_nodate}. 

\subsubsection*{Acknowledgement}

In particular, I thank Tom Brown for very fruitful discussions. I am very grateful to Alexander Zerrahn for reviewing and helping out with important parts. Further, I want to thank Alexander Kies and Markus Schlott who steadily helped with creative thoughts.



% ----------------------- APPENDIX -------------------------------------

\clearpage
\appendix

\section{Network Optimization}

\renewcommand\theequation{\thesection.\arabic{equation}}
\setcounter{equation}{0}

\renewcommand\thefigure{\thesection.\arabic{figure}}    
\setcounter{figure}{0}    

\subsection{LMP from Optimization}
\label{sec:lmp}
The nodal balance constraint ensures that the amount of power that flows into a bus equals the power that flows out of a bus, thus reflects the Kirchhoff Current Law (KCL). With a given demand $\demand$ this translates to   
\begin{align}
    \nodalgeneration - \sum_\ell \incidence \flow  &=  \demand 
    % \sum_l \incidence \, \flow  - \nodalgeneration + \nodaldemand &= 0
     \resultsin{\lmp} \Forall{n,t}
    \label[constraint]{eq:nodal_balance_lin}
\end{align}
where $\incidence$ is +1 if line $\ell$ starts at bus $n$, -1 if it ends at $n$, 0 otherwise. The nodal generation $\nodalgeneration$ collects the production of all nodal assets, see \cref{eq:nodalgeneration}. The shadow price of the nodal balance constraint mirrors the Locational Marginal Prizes (LMP) $\lmp$ per bus and time step. In a optimal nodal pricing scheme this is the \euro/\megawatthour price which a consumer has to pay.\\

\subsection{Full Lagrangian}
\label{sec:full_lagrangian}
The Lagrangian for the investment model can be condensed to the following expression

\begin{align}
\notag
& \lagrangian\left(\state, \capacity, \lmp, \mu_j \right) = \\ 
\notag
& \qquad + \sum_{i,t} o_i \state + \sum_{i} c_i \capacity  \\
\notag
&\qquad +  \sum_{n,t} \lmp \left( \demand - \nodalgeneration + \sum_\ell \incidence \, \flow \right) \\
&\qquad + \sum_j \mu_j \, h_j \left(\state, \capacity \right)
\label{eq:full_lagrangian}
\end{align}
where $h_j \left(\state, \capacity \right)$ denotes all inequality constraints attached to $\state$ and $\capacity$. In order to impose the Kirchhoff Voltage Law (KVL) for the linearized AC flow, the term 
\begin{align}
    \sum_{\ell,c,t} \cycleprice \, \cycle \, \reactance \, \flow 
\end{align}
can be added to $\lagrangian$, with $\reactance$ denoting the line's impedance and $\cycle$ being 1 if $\ell$ is part of the cycle $c$ and zero otherwise.

The global maximum of the Lagrangian requires stationarity with respect to all variables:
\begin{align}
    \pdv{\lagrangian}{\state} = \pdv{\lagrangian}{\capacity} = 0    
\end{align} 



\subsection{Zero Profit Generation}
\label{sec:zero_profit_generation}
Let $S \subseteq I$ be the set of generators in the network, such that $\generation = s_{s,t}$ describes the power production of generator $s \in S$. The OPEX occasioned by generator $s$ is given by a cost-weighted sum of the production, thus 
\begin{align}
    \opexgeneration_s = \sum_t \operationalpricegeneration \, \generation 
    \label{eq:opexgeneration}
\end{align}
In case a fix price for emissions $\emissionprice$ in \euro\, per tonne-CO$_2$ equivalents, is assumed, a further the cost term per generator $s$,   
\begin{align}
 \emissioncost_s = \emissionprice \, \sum_t  \emission \, \generation
\end{align}
adds to $\totalcost$. Here, $\emission$ denotes the emission factor in tonne-CO$_2$ per \megawatthour\, of generator $s$. In contrast to OPEX and emission costs, the CAPEX of $s$ are not a function of the production $\generation$, but of the actual installed capacity $\capacitygeneration$ of generator $s$. In the optimization it limits the generation $\generation$ in the form of 
\begin{align}
\generation - \capacitygeneration  &\le 0 \resultsin{\muuppergeneration} \Forall{s,t} 
\label[constraint]{eq:upper_generation_capacity_constraint}
\end{align}
The constraint yields a shadow-price of $\muuppergeneration$, given by corresponding the Karush–Kuhn–Tucker (KKT) variable, in literature often denoted as the Quality of Supply \cite{schweppe_spot_1988}. It can be interpreted as the price per MW that \cref{eq:upper_generation_capacity_constraint} imposes to the system. If $\muuppergeneration$  is bigger than zero, the constraint is binding, which pushes investments in $\capacitygeneration$. As shown in \cite{brown_decreasing_2020} and in detail in \cref{sec:zero_profit_generation}, over the whole time span, the CAPEX for generator $s$ is recovered by the production $\generation$ times the shadow price $\muuppergeneration$, 
\begin{align}
 \capexgeneration_s = \capitalpricegeneration \capacitygeneration = \sum_t \muuppergeneration \,  \generation 
 \label{eq:no_profit_capex_generation}
\end{align}
This representation connects the CAPEX with the operational state of generator $s$, \ie matches the form in \cref{eq:cost_decomposition}.   

For each generator the optimization defines a lower capacity constraint, given by 
\begin{align}
    - \generation &\le 0 \resultsin{\mulowergeneration} \Forall{s,t} 
    \label[constraint]{eq:lower_generation_capacity_constraint}
\end{align} 
\Cref{eq:upper_generation_capacity_constraint,eq:lower_generation_capacity_constraint}, which yield the KKT variables $\muuppergeneration$ and $\mulowergeneration$, imply the complementary slackness,
\begin{align}
\muuppergeneration \left( \generation - \generationpotential \, \capacitygeneration \right)  &= 0  \Forall{s,t} 
\label{eq:complementary_slackness_upper_generation} \\
\mulowergeneration  \, \generation &= 0 \Forall{s,t}
\label{eq:complementary_slackness_lower_generation} 
\end{align}


The stationarity of the generation capacity variable leads to 
\begin{align}
\pdv{\lagrangian}{\capacitygeneration}  = 0 \,\, \rightarrow \,\, 
\capitalpricegeneration =  \sum_t \muuppergeneration \, \generationpotential  \Forall{s}
\label{eq:capex_generation_duality}
\end{align}
and the stationarity of the generation to 
\begin{align}
\pdv{\lagrangian}{\generation} &= 0 \,\, \rightarrow \,\,  
\operationalpricegeneration =  \sum_n \incidencegenerator \, \lmp - \muuppergeneration + \mulowergeneration \Forall{s} \label{eq:opex_duality}
\end{align}


Multiplying both sides of \cref{eq:capex_generation_duality} with $\capacitygeneration$ and using \cref{eq:complementary_slackness_upper_generation} leads to 
\begin{align}
 \capitalpricegeneration \, \capacitygeneration  = \sum_t \muuppergeneration \, \generation \Forall{s} 
 \label{eq:capital_price_generation_sum}
\end{align}
The zero-profit rule for generators is obtained by multiplying \cref{eq:opex_duality} with $\generation$ and using \cref{eq:complementary_slackness_lower_generation,eq:capital_price_generation_sum} which results in 
\begin{align}
  \capitalpricegeneration \, \capacitygeneration + \sum_t \operationalpricegeneration \generation = \sum_{n,t} \lmp \incidencegenerator \generation \Forall{s}
\end{align}
It states that over the whole time span, all OPEX and CAPEX for generator $s$ (left hand side) are payed back by its revenue (right hand side).

\subsection{Zero Profit Transmission System}
\label{sec:zero_profit_flow}

Let $L \subset I$ be the set of transmission lines in the system, these may include Alternating Current (AC) as well as Directed Current (DC) lines. Further let $\flow = s_{\ell,t}$ represent the power flow on line $\ell \in L$.  If the OPEX of the transmission system is taken into account in $\totalcost$ (these are often neglected in power system models), these may be approximated by $\opexflow_\ell = \sum_t o_\ell |\flow|$, that is, a cost weighted sum of the net flow on line $\ell$. Again this stands in contrast to the CAPEX which not a function of $\flow$ but of the transmission capacity $\capacityflow$. It limits the flow $\flow$ in both directions,
\begin{align}
\flow - \capacityflow &\le 0 \resultsin{\muupperflow} \Forall{\ell,t} 
\label[constraint]{eq:upper_flow_capacity_constraint} \\
- \flow - \capacityflow &\le 0 \resultsin{\mulowerflow} \Forall{\ell,t} 
\label[constraint]{eq:lower_flow_capacity_constraint}
\end{align}
At the cost-optimum, the two constraints yield the shadow prices $\muupperflow$ and $\mulowerflow$. Again, we use the relation that over the whole time span, the shadow prices weighted by the flow match the investment in line $\ell$ (for details see \cref{sec:zero_profit_flow}) 
\begin{align}
\capexflow_\ell = \capitalpriceflow \capacityflow = \sum_{t} \left( \muupperflow - \mulowerflow \right)  \flow 
\label{eq:no_profit_capex_flow}
\end{align}
The shadow prices $\muupperflow$ and $\mulowerflow$ can be seen as a measure for necessity of transmission investments at $\ell$ at time $t$. Hence, a non-zero values indicate that \cref{eq:upper_flow_capacity_constraint} or \eqref{eq:lower_flow_capacity_constraint} are bound and therefore that the congestion on line $\ell$ at time $t$ is imposing costs to the system. 

The yielding KKT variables $\muupperflow$ and $\mulowerflow$ are only non-zero if $\flow$ is limited by the transmission capacity in positive or negative direction, i.e. \cref{eq:upper_flow_capacity_constraint} or \cref{eq:lower_flow_capacity_constraint} are binding. For flows below the thermal limit, the complementary slackness 
\begin{align}
\muupperflow \left( \flow - \capacityflow \right)  &= 0 \Forall{\ell,t}
\label{eq:complementary_slackness_upper_flow} \\
\mulowerflow \left( \flow - \capacityflow \right) &=  0 \Forall{\ell,t}
\label{eq:complementary_slackness_lower_flow} 
\end{align}
sets the respective KKT to zero. 

The stationarity of the transmission capacity leads to
\begin{align}
\pdv{\lagrangian}{\capacityflow} = 0 \,\, \rightarrow \,\, 
\capitalpriceflow =  \sum_t \left( \muupperflow - \mulowerflow \right) \Forall{\ell}
\label{eq:capacity_flow_duality}
\end{align}
and the stationarity with respect to the flow to
\begin{align}
    0 &= \pdv{\lagrangian}{\flow}  \\ 
    0 &= - \sum_n \incidence \lmp  + \sum_c \cycleprice \cycle \reactance  - \muupperflow + \mulowerflow \Forall{\ell, t} \label{eq:flow_duality}
\end{align}
    
    
When multiplying \cref{eq:capacity_flow_duality} with $\capacityflow$ and using the complementary slackness \cref{eq:complementary_slackness_upper_flow,eq:complementary_slackness_lower_flow} we obtain 
\begin{align}
 \capitalpriceflow \, \capacityflow = \sum_t \left( \muupperflow - \mulowerflow \right)  \, \flow \Forall{\ell} 
 \label{eq:capital_price_flow_sum}
\end{align}
Again we can use this to formulate the zero-profit rule for transmission lines. We multiply \cref{eq:flow_duality} with $\flow$, which finally leads us to 
\begin{align}
\capitalpriceflow \, \capacityflow = - \sum_n \incidence\, \lmp\, \flow + \sum_c \cycleprice\, \cycle\, \reactance\, \flow 
\Forall{\ell} \end{align}
% Watch out Incidence = - ordinary Incidence !!
It states that the congestion revenue of a line (first term right hand side) reduced by the cost for cycle constraint exactly matches its CAPEX. 


\subsection{Zero Profit Storage Units}
\label{sec:zero_profit_storage_units}

Let $R \subset I$ denote all storages in the system. In a simplified storage model, $\capacitystorage$ limits the storage dispatch $\storagedispatch$ and charging $\storagecharge$. Further it limits the maximal storage capacity $\storagesoc$ by a fix ratio $h_r$, denoting the maximum hours at full discharge. The storage $r$ dispatches power with efficiency $\efficiencydispatch$, charges power with efficiency $\efficiencycharge$ and preserves power from one time step $t$ to the next, $t+1$, with an efficiency of $\efficiencysoc$. In \cref{sec:zero_profit_storage_units} we formulate the mathematical details. The OPEX which adds to $\totalcost$ is given by 
\begin{align}
    \opexstorage = \sum_r o_r \storagedispatch 
\end{align}
Using the result of \cite{brown_decreasing_2020} the CAPEX can be related to the operation of a storage unit $r$ through
\begin{align}
    \notag
    \capexstorage =& \capitalpricestorage \, \capacitystorage \\
    \notag
    =& \sum_t \left(\muupperstoragedispatch - \mulowerstoragedispatch  + (\efficiencydispatch )^{-1} \mustateofcharge \right) \storagedispatch \\
    &- \sum_t \lmp \incidencestorage  \storagecharge \Forall{r} 
    \label{eq:no_profit_capex_storage}
\end{align}
where $\muupperstoragedispatch$ and $\mulowerstoragedispatch$ are the shadow prices of the upper and lower dispatch capacity bound and $\mustateofcharge$ is the shadow price of the energy balance constraint. Following the considerations in \cref{sec:zero_profit_storage_units} we restrict to the revenue from dispatched power, \ie the first term in \cref{eq:no_profit_capex_storage}, for the cost allocation.   

For an simplified storage model, the upper capacity $\capacitystorage$ limits the discharging dispatch $\storagedispatch$, the storing power $\storagecharge$ and state of charge $\storagesoc$ of a storage unit $r$ by 
\begin{align}
    \storagedispatch - \capacitystorage &\le 0  \resultsin{\muupperstoragedispatch} \Forall{r,t} \\
    \storagecharge - \capacitystorage &\le 0  \resultsin{\muupperstoragecharge} \Forall{r,t} \\
    \storagesoc - h_r \, \capacitystorage &\le 0  \resultsin{\muupperstoragesoc} \Forall{r,t}
\end{align}
where we assume a fixed ratio between dispatch and storage capacity of $h_r$. 
% From stationarity we obtain 
% \begin{align}
%     \notag
%     \pdv{\lagrangian}{\capacitystorage} &= 0 \\
%     \capitalpricestorage &= \sum_t \left( \muupperstoragedispatch + \muupperstoragecharge + h_r \muupperstoragesoc  \right)
% \end{align}
The state of charge must be consistent throughout every time step according to what is dispatched and stored, 
\begin{align}
    \notag
    \storagesoc - \efficiencysoc \storageprevioussoc - \efficiencycharge \storagecharge &+ (\efficiencydispatch)^{-1} \storagedispatch = 0 \\
    &\resultsin{\mustateofcharge} \Forall{r,t}
\end{align}



We use the result of Appendix B.3 in \cite{brown_decreasing_2020} which shows that a storage recovers its capital (and operational) costs from aligning dispatch and charging to the LMP, thus 
\begin{align}
    \notag
    \sum_t \operationalpricestorage \, \storagedispatch + \capitalpricestorage \, \capacitystorage = \sum_t \lmp \incidencestorage &\left(\storagedispatch - \storagecharge \right) \Forall{r,t}
\end{align}
The stationarity of the dispatched power leads us to  
\begin{align}
    \notag
    \pdv{\lagrangian}{\storagedispatch} &= 0 \\
    \operationalpricestorage - \sum_n \lmp \, \incidencestorage - \mulowerstoragedispatch + \muupperstoragedispatch + (\efficiencydispatch )^{-1} \mustateofcharge &= 0 \;  \forall r,t
    \label{eq:stationarity_storagedispatch}
\end{align}
which we  can use to define the revenue which recovers the CAPEX at $r$, 
\begin{align}
    \notag
    \capitalpricestorage \, \capacitystorage = \sum_t \left(\muupperstoragedispatch - \mulowerstoragedispatch  + (\efficiencydispatch )^{-1} \mustateofcharge \right) \storagedispatch \\
    - \sum_t \lmp \incidencestorage  \storagecharge \Forall{r} 
    \label{eq:no_profit_capex_storage2}
\end{align}

% With this constraint we can derive the following stationarities:
% \begin{align}
%     \notag
%     \pdv{\lagrangian}{\storagedispatch} &= 0 \\
%     \operationalpricestorage + \lmp + \mulowerstoragedispatch - \muupperstoragedispatch - (\efficiencydispatch )^{-1} \mustateofcharge &= 0  
%     \label{eq:stationarity_storagedispatch}
% \end{align}
% \begin{align}
%     \notag
%     \pdv{\lagrangian}{\storagecharge} &= 0 \\
%     - \lmp + \mulowerstoragecharge - \muupperstoragecharge + \efficiencycharge \mustateofcharge &= 0 
%     \label{eq:stationarity_storagecharge}
% \end{align}
% \begin{align}
%     \notag
%     \pdv{\lagrangian}{\storagesoc} &= 0 \\
%     \mulowerstoragesoc - \muupperstoragesoc - \mustateofcharge + \efficiencysoc \munextstateofcharge &= 0 
%     \label{eq:stationarity_storagesoc}
% \end{align}


When applying the cost allocation scheme \cref{eq:general_scheme}, it stands to reason to assume that when a storage charges power, it does not supply any demand. Thus consumers only pay storage units in times the storage dispatches power. Hence, we restrict the allocatable revenue per storage unit to the first term in \cref{eq:no_profit_capex_storage,eq:no_profit_capex_storage2}. This allocates then the CAPEX of $r$ plus the costs $\remainingcost^E_r$ it needs to buy the charging power, 
\begin{align}
        \capexstorage_r + \remainingcost^E_r = \sum_t \left(\muupperstoragedispatch - \mulowerstoragedispatch  + (\efficiencydispatch )^{-1} \mustateofcharge \right) \storagedispatch 
\end{align} 
In charging times the total of remaining costs $\remainingcost^E_r$ is spent to power from other assets. These costs scale with the amount of installed storage capacity.
Note that it would be possible to incorporate this redistribution into the cost allocation, by replacing the demand $\demand$ with the power charge $\storagecharge$ in \cref{eq:general_scheme}. Then, the derived payments that a storage unit $r$ has to pay to asset $i$ is given by $\cost_{r \rightarrow i}$. The sum of those payments due to $r$ will the sum up to $\remainingcost^E_r$. 


\subsection{Capacity Expansion Limit}

\begin{subequations}
In real-world setups the capacity expansion of generators, lines or other assets are often limited. This might be due to land use restrictions or social acceptance considerations. 
When constraining the capacity $\capacity$ to an upper limit $\capacityupper$, in the form of 
\begin{align}
    \capacity - \capacityupper \le 0 \resultsin{\muuppernom} \Forall{i \in I}
\label{eq:capacityexpansionmaximum},
\end{align}
the zero profit condition alters as soon as the constraint becomes binding. Then, asset $i$ is payed an additional scarcity rent 
\begin{align}
    \scarcitycost_i = - \muuppernom \capacity \Forall{i \in I}
    \label{eq:scarcitycost}
\end{align}
This rent may account for different possible realms, as for example the increased market price in higher competed areas or additional costs for social or environmental compensation. To end this, the share in $\allocatecost$ which consumers pay for the scarcity rent can be recalculated by a correct weighting of the shadow price $\muuppergenerationnom$ with the capital price $c_i$, leading to 
\begin{align}
    \allocatescarcitycost = \dfrac{\muuppernom}{c_i + \muuppernom} \, \allocatecost \Forall{i}
\end{align}
\end{subequations}


\subsection{Brownfield Constraints}

\begin{subequations}
In order to take already built infrastructure into account, the capacity $\capacity$ may be constrained by a minimum required capacity $\capacitylower_i$. This introduces a constraint of the form 
\begin{align}
    \capacitylower - \capacity  \le 0 \resultsin{\mulowernom} \hpad \forall{i \in I}
\label{eq:capacityexpansionminimum}
\end{align}
Again, such a setup alters the zero profit condition of asset $i$, as soon as the constraint becomes binding. 
In that case, asset $i$ does not collect enough revenue from $\allocatecost$ in order to compensate the CAPEX. The difference, given by 
\begin{align}
    \subsidycost_i = \mulowernom \capacity
    \Forall{i}
\end{align}
has to be subsidized by governments or communities or is simply ignored when investments are amortized. Note, it is rather futile wanting to allocate these cost to consumers as assets may not gain any revenue for their operational state, \ie where $\cost_i = \subsidycost_i $. 
\end{subequations}


\subsection{Proof: Equivalence of local and imported prices}
\label{sec:proof_equivalence}

We start with \cref{eq:flow_duality} which we recall here, 
\begin{align}
    \notag
    0 = &- \sum_m \incidence[m] \lmp[m]  + \sum_c  \cycleprice \cycle \reactance  \\
    &- \muupperflow + \mulowerflow \Forall{\ell,t} 
\end{align}
It states that the price difference between two adjacent buses minus the price for the KVL, is the revenue per line $\ell$, $\left(- \muupperflow + \mulowerflow\right)$. We multiply the equation by the flow allocation $\allocateflow$ and obtain 
\begin{align}
    \notag
    0 =& - \allocateflow \sum_m \incidence[m] \lmp[m]  \\
    \notag
    &+ \allocateflow \sum_c  \cycleprice \cycle \reactance  \\
    &- \allocateflow \left(\muupperflow - \mulowerflow\right) \Forall{\ell,t} 
    \label{eq:flow_duality2}
\end{align}  
The allocation $\allocateflow$ defined in \cref{eq:allocate_flow}follows the linear power flow laws. We slightly reformulate the expression to
\begin{align}
    \allocateflow = \sum_{m'} \ptdf[m'] \left( \allocatepeer[m' \rightarrow n]  - \delta_{n m'} \demand \right) \Forall{\ell, n, t}
    \label{eq:allocate_flow2}
\end{align}
and insert it into \cref{eq:flow_duality2}. When taking the sum over all lines $L$, the first term yields  
\begin{align}
    \notag
    &- \sum_{\ell, m'} \ptdf[m'] \left( \allocatepeer[m' \rightarrow n]  - \delta_{n m'} \demand \right) \sum_m \incidence[m] \lmp[m] \\
    \notag
    =& - \sum_{\ell, m', m} \ptdf[m'] \left( \allocatepeer[m' \rightarrow n]  - \delta_{n m'} \demand \right) \incidence[m] \lmp[m] \\
    \notag
    =& - \sum_{m', m} \delta_{m m'} \left( \allocatepeer[m' \rightarrow n]  - \delta_{n m'} \demand \right) \lmp[m] \\
    \notag
    =& - \sum_{m} \left( \allocatepeer - \delta_{n m} \demand \right) \lmp[m] \\
    =& - \sum_{m} \allocatepeer \lmp[m] + \demand \lmp 
\end{align}
where in the third step we used the relation $\sum_\ell \ptdf \incidence[m] = \delta_{n m}$.
The second term in \cref{eq:flow_duality2} vanishes as the basis cycles $\cycle$ are the kernel of the PTDF, $\sum_{\ell} \cycle \ptdf  = 0 \; \forall c,n$. Thus, we end up with 
\begin{align}
    \notag
    \demand \lmp =& \sum_{m} \allocatepeer \lmp[m] \\
    +& \sum_\ell \allocateflow \left(\muupperflow - \mulowerflow\right) \Forall{n,t}
\end{align}
This relation shows that for any P2P allocations $\allocatepeer$ the combined price of the imported power is always be the same as the locational price. The representation matches the findings in \cite{wu_locational_2005}. However, the latter builds its formulation on a evenly distributed slack, which translated to a peer-to-peer allocation $\allocatepeer$ corresponding to the non-local Equivalent Bilateral Exchanges \cite{galiana_transmission_2003}. However, the representation here holds only true any $\allocatepeer$ if the corresponding flow allocation $\allocateflow$ follow the power flow laws, \ie are defined as in \cref{eq:allocate_flow,eq:allocate_flow2}. 

Naturally, the power production of the supplying node $m$ decomposes into contributions of assets, following the definition in \cref{eq:allocate_production}. At the same time, the LMP at $m$ decomposes into asset related prices (\cref{eq:opex_duality,eq:stationarity_storagedispatch}). This finally reproduces the allocations of \cref{tab:cost_allocation_map} and results in 
\begin{align}
    \demand \, \lmp =  \sum_{\circ, i} \allocatecost 
\end{align}


\section{Power Allocation}
\label{sec:net_ap}

\newcommand{\incidenceM}{K}
\newcommand{\flowM}{f}
\newcommand{\injectionM}{p}
\newcommand{\slackM}{k}
\newcommand{\DirectedIncidence}{\mathcal{K}}
\newcommand{\InverseAPInjection}{\mathcal{J}}
\newcommand\diag[1]{\operatorname{diag}\left(#1\right)}


Allocating net injections using the AP method is derived from \cite{achayuthakan_electricity_2010}. In a lossless network the downstream and upstream formulations result in the same P2P allocation which is why we restrict ourselves to the downstream formulation only. In a first step we define a time-dependent auxiliary matrix $\InverseAPInjection_t$ which is the inverse of the $N\times N$ with directed power flow $m \rightarrow n$ at entry $(m, n)$ for $m \ne n$ and the total flow passing node $m$ at entry $\left( m, m\right)$ at time step $t$. Mathematically this translates to


\begin{align}
\InverseAPInjection_t = \left( \diag{\injectionM^+} + \DirectedIncidence^- \diag{\flowM} \, \incidenceM \right)_t^{-1} 
\end{align}
where $\DirectedIncidence^-$ is the negative part of the directed Incidence matrix $\DirectedIncidence_{n,\ell} = \text{sign}\left( f_\ell \right)  \incidence$. Then the P2P allocation for time step $t$ is given by
\begin{align}
\allocatepeer = \InverseAPInjection_{m,n,t} \, \netproduction[m] \, \netconsumption
\end{align}

\section{Working Example}
The following figures contain more detailed information about the peer-to-peer cost allocation discussed in \cref{sec:application_case}. The cost or prices payed by consumers are indicated by the region color. The dedicated revenue is displayed in proportion to the size of cycles (for assets attached to buses) or to the thickness of transmission branches.    
% \begin{figure*}
%     \centering
%     \begin{subfigure}[c]{.49\linewidth}
%         \includegraphics[width=\linewidth]{de50bf/maps_price_ptpf_net/one_port_investment_cost_total}
%         \subcaption{All production and storage technologies}
%         \label{fig:total_capex}
%     \end{subfigure}
%     \begin{subfigure}[c]{.49\linewidth}
%         \includegraphics[width=\linewidth]{de50bf/maps_price_ptpf_net/by_carrier/onwind_one_port_investment_cost}
%         \subcaption{Onshore Wind}
%         \label{fig:onshore_capex}
%     \end{subfigure}
%     \begin{subfigure}[c]{.49\linewidth}
%         \includegraphics[width=\linewidth]{de50bf/maps_price_ptpf_net/by_carrier/solar_one_port_investment_cost}
%         \subcaption{Solar}
%         \label{fig:solar_capex}
%     \end{subfigure}
%     \begin{subfigure}[c]{.49\linewidth}
%         \includegraphics[width=\linewidth]{de50bf/maps_price_ptpf_net/by_carrier/OCGT_one_port_investment_cost}
%         \subcaption{OCGT}
%         \label{fig:ocgt_capex}
%     \end{subfigure}
%     \caption{Average \textbf{CAPEX allocation} per MWh, $\sum_t \allocatecapex / \sum_t \demand$  for all production and storage assets (a), onshore wind (b), solar (c) and OCGT (d). Average allocated CAPEX per MWh within the regions are indicated by the color, the revenue per production asset is given by the size of the circles at the corresponding bus.}
%     \label{fig:capex_price}
% \end{figure*}

% \begin{table*}[h]
%     \centering
%     \input{../tables/de50bf_ptpf_net/prices}    
%     \caption{Operational and capital price assumptions for all type of assets used in the working example. The capital price for transmission lines are given in [k\,\euro/MW/km]. The cost assumptions are retrieved from the PyPSA-EUR model \cite{horsch_jonas_pypsa-eur_2020}.}
%     \label{tab:cost_assumptions}
% \end{table*} 



% \begin{figure}
%     \includegraphics[width=\linewidth]{de50bf/average_demand}
%     \caption{Average demand, $\sum_t \demand/T$ per regions. The regions with high population densities and larger areas reveal a higher demand.}
%     \label{fig:average_demand}
% \end{figure}


% \begin{figure}
%     \includegraphics[width=\linewidth]{de50bf/power_mix_ptpf_net}
%     \caption{Average power mix per region calculated by Average Participation. Coastal regions are mainly supplied by local offshore and onshore wind farms. Their strong power injections additionally penetrate the network up to the southern border. In the middle and South, the supply is dominated by a combination of OCGT and solar power.}
%     \label{fig:power_mix}
% \end{figure}

% \begin{figure}
%     \vspace{2cm}
%     \includegraphics[width=\linewidth]{de50bf/subsidy}
%     \caption{Total costs for subsidy $\subsidycost$ resulting from lower capacity expansion bounds (brownfield constraints). The figure shows the built infrastructure that does not gain back its CAPEX from its market revenue, but is only built due to lower capacity limits.}
%     \label{fig:subsidy}
% \end{figure}


% \begin{figure*}
%     \includegraphics[width=\linewidth]{de50bf/capex_duration_curve}
%     \caption{Duration curve of the CAPEX allocation for production and storage technologies. Hours are sorted by the total amount of allocated expenditure. With 2.7 bn~\euro\, the first value pushes investments extraordinarily high. Due to low renewable potentials, it is dominated by CAPEX for OCGT which receives 92\% of the payments. This hour alone occasions about the half of all OCGT CAPEX. \Cref{fig:capex_duration_curve} gives a detailed picture of the operational state at this time-step. The following 7000 time-steps are dominated by revenues for onshore wind and reveal a rather even distribution. In hours of low CAPEX allocation (after the second drop) spending for OCGT start to increase again. These time-steps however play a minor role.}
%     \label{fig:capex_duration_curve}
% \end{figure*}

% \begin{figure}
%     \includegraphics[width=\linewidth]{de50bf/operation_high_expenditure}
%     \caption{Production, flow and consumption in the system at the hour with the highest allocated expenditures. The size of the circles are proportional to the power production at a node. Size of arrows are proportional to the flow on the transmission line. The depicted hour corresponds to the first value in the duration curve in \cref{fig:capex_duration_curve}.}
%     \label{fig:operation_high_expenditure}
% \end{figure}


% \begin{figure}
%     \includegraphics[width=\linewidth]{de50bf/maps_scarcity_price_ptpf_net/branch_scarcity_cost_total}
%     \caption{Average \textbf{allocated transmission scarcity cost} per consumed MWh, $\sum_t \scarcitycost_{n \rightarrow \ell, t} / \sum_t \demand $. This scarcity cost results from the upper transmission expansion limit of 25\%. The costs are indicated by the regional color.  The lines are drawn in proportion to revenue dedicated to scarcity cost. }
%     \label{fig:branch_scarcity_price}
% \end{figure}




% \begin{figure*}
%     \centering
%     \begin{subfigure}[c]{.49\linewidth}
%         \includegraphics[width=\linewidth]{de50bf/maps_scarcity_price_ptpf_net/by_carrier/offwind-dc_generator_scarcity_cost}
%         \subcaption{Offshore Wind}
%         \label{fig:offwind-dc_generator_scarcity_cost}
%     \end{subfigure}
%     \begin{subfigure}[c]{.49\linewidth}
%         \includegraphics[width=\linewidth]{de50bf/maps_scarcity_price_ptpf_net/by_carrier/onwind_generator_scarcity_cost}
%         \subcaption{Onshore Wind}
%         \label{fig:onwind_generator_scarcity_cost}
%     \end{subfigure}
%     \begin{subfigure}[c]{.49\linewidth}
%         \includegraphics[width=\linewidth]{de50bf/maps_scarcity_price_ptpf_net/by_carrier/solar_generator_scarcity_cost}
%         \subcaption{Solar}
%         \label{fig:solar_generator_scarcity_cost}
%     \end{subfigure}
%     \begin{subfigure}[c]{.49\linewidth}
%         \includegraphics[width=\linewidth]{de50bf/maps_scarcity_price_ptpf_net/by_carrier/ror_generator_scarcity_cost}
%         \subcaption{Run-of-River}
%         \label{fig:ror_generator_scarcity_cost}
%     \end{subfigure}
%     \caption{Average \textbf{allocated scarcity cost} per consumed MWh, $\sum_t \allocatescarcitycost / \sum_t \demand$. These cost result from land use restrictions for offshore wind, onshore wind,  solar, run-of-river. The cost per MWh are indicated by the color of a region. The revenue per production asset is given by the size of the circle at the corresponding bus.}
%     \label{fig:scarcity_price}
% \end{figure*}





\clearpage
\printbibliography





\end{document}
